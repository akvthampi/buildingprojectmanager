<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>React Flashcards from PDF</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    header { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 12px; align-items: center; }
    main { padding: 16px; max-width: 1100px; margin: 0 auto; }
    .grid { display: grid; gap: 12px; }
    @media (min-width: 900px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
    textarea { width: 100%; min-height: 220px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; }
    input[type="range"] { width: 240px; }
    .btn { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; cursor: pointer; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #2563eb; border-color: #2563eb; color: #fff; }
    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
    .perspective{ perspective: 1000px; }
    .preserve-3d{ transform-style: preserve-3d; }
    .backface-hidden{ backface-visibility: hidden; }
    .rotate-y-180{ transform: rotateY(180deg); }
    .card { position: relative; height: 180px; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #fff; cursor: pointer; }
    .flip { position: relative; width: 100%; height: 180px; transition: transform .5s; }
    .front, .back { position: absolute; inset: 0; }
    .front { background: #fff; }
    .back { background: #f9fafb; transform: rotateY(180deg); }
    .muted { color: #6b7280; font-size: 12px; }
    .stat { display: inline-block; padding: 2px 8px; border: 1px solid #e5e7eb; border-radius: 999px; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
  </style>
  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.3.1",
      "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
      "pdfjs-dist": "https://esm.sh/pdfjs-dist@4.7.76/build/pdf.mjs"
    }
  }
  </script>
</head>
<body>
  <header>
    <strong>React Flashcards</strong>
    <span class="stat">Upload PDF → Extract → Generate → Study</span>
  </header>
  <main>
    <div id="root"></div>
  </main>

  <script type="module">
    import React, { useEffect, useMemo, useRef, useState, useCallback } from "react";
    import { createRoot } from "react-dom/client";
    import * as pdfjsLib from "pdfjs-dist";

    // Configure PDF.js worker via CDN path
    // pdfjs-dist 4.x requires a worker; point to the CDN worker file.
    // Version must match the import above.
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://esm.sh/pdfjs-dist@4.7.76/build/pdf.worker.mjs";

    // Utilities
    function chunkText(text, targetSize = 500) {
      const sentences = text.split(/(?<=[.?!])\s+/);
      const chunks = [];
      let cur = "";
      for (const s of sentences) {
        if ((cur + " " + s).length > targetSize && cur) {
          chunks.push(cur.trim());
          cur = s;
        } else {
          cur = cur ? cur + " " + s : s;
        }
      }
      if (cur) chunks.push(cur.trim());
      return chunks.filter(c => c.length > 20);
    }

    function generateQAFromChunk(chunk) {
      const firstSentence = (chunk.split(/(?<=[.?!])\s+/)[0] || chunk.slice(0, 140)).trim();
      const question = `What is the key idea: "${firstSentence.slice(0, 140)}"?`;
      const answer = chunk.trim();
      return { question, answer };
    }

    async function extractPdfText(file) {
      const buffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
      const pages = [];
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const text = content.items.map(it => it.str).join(" ");
        pages.push(text);
      }
      return { pages };
    }

    // Flashcard component
    function Flashcard({ q, a }) {
      const [flip, setFlip] = useState(false);
      return (
        <div className="card perspective" onClick={() => setFlip(v => !v)} role="button" aria-pressed={flip}>
          <div className={"flip preserve-3d " + (flip ? "rotate-y-180" : "")}>
            <div className="front backface-hidden">
              <div className="muted mono">Q</div>
              <div style={{marginTop: 6}}>{q}</div>
            </div>
            <div className="back backface-hidden">
              <div className="muted mono">A</div>
              <div style={{marginTop: 6, whiteSpace: "pre-wrap"}}>{a}</div>
            </div>
          </div>
        </div>
      );
    }

    function App() {
      const [file, setFile] = useState(null);
      const [extracting, setExtracting] = useState(false);
      const [pages, setPages] = useState([]);
      const [size, setSize] = useState(500);
      const [chunks, setChunks] = useState([]);
      const [cards, setCards] = useState([]);
      const [i, setI] = useState(0);

      const textPreview = useMemo(() => pages.slice(0, 2).join("\n\n"), [pages]);
      const chunkPreview = useMemo(() => chunks.slice(0, 5).join("\n\n---\n\n"), [chunks]);

      async function onExtract() {
        if (!file) return;
        setExtracting(true);
        try {
          const { pages } = await extractPdfText(file);
          setPages(pages);
          const all = pages.join("\n\n");
          setChunks(chunkText(all, size));
        } finally {
          setExtracting(false);
        }
      }

      function onGenerate() {
        const gen = chunks.map(c => generateQAFromChunk(c));
        setCards(gen);
        setI(0);
      }

      const next = useCallback(() => setI(x => Math.min(x + 1, Math.max(0, cards.length - 1))), [cards.length]);
      const prev = useCallback(() => setI(x => Math.max(x - 1, 0)), []);
      useEffect(() => {
        function onKey(e) {
          if (e.key === "ArrowRight") next();
          if (e.key === "ArrowLeft") prev();
        }
        window.addEventListener("keydown", onKey);
        return () => window.removeEventListener("keydown", onKey);
      }, [next, prev]);

      const current = cards[i];

      return (
        <div>
          <section className="grid grid-2">
            <div>
              <h2>1) Upload PDF</h2>
              <input type="file" accept="application/pdf" onChange={e => setFile(e.target.files?.[0] || null)} />
              <div className="row" style={{marginTop: 10}}>
                <label>Chunk size</label>
                <input type="range" min="200" max="1200" step="50" value={size}
                       onChange={e => setSize(parseInt(e.target.value))}/>
                <span className="mono">{size} chars</span>
                <button className="btn" onClick={onExtract} disabled={!file || extracting}>
                  {extracting ? "Extracting..." : "Extract"}
                </button>
              </div>
              <div style={{marginTop: 10}}>
                <div className="muted">Extracted text preview</div>
                <textarea readOnly value={textPreview}></textarea>
              </div>
            </div>

            <div>
              <h2>2) Chunks → Cards</h2>
              <div className="muted">Chunks preview</div>
              <textarea readOnly value={chunkPreview}></textarea>
              <div className="row" style={{marginTop: 8}}>
                <button className="btn btn-primary" onClick={onGenerate} disabled={!chunks.length}>Generate Cards</button>
                <span className="stat">Chunks: {chunks.length}</span>
                <span className="stat">Cards: {cards.length}</span>
              </div>
            </div>
          </section>

          <section style={{marginTop: 20}}>
            <h2>3) Study</h2>
            {!cards.length && <div className="muted">No cards yet. Generate from chunks.</div>}
            {!!cards.length && (
              <div>
                <div className="row">
                  <span className="stat">Card {i + 1} / {cards.length}</span>
                  <button className="btn" onClick={prev}>Prev</button>
                  <button className="btn" onClick={next}>Next</button>
                </div>
                <div className="cards" style={{marginTop: 12}}>
                  <Flashcard q={current?.question || ""} a={current?.answer || ""} />
                </div>
              </div>
            )}
          </section>
        </div>
      );
    }

    const root = createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
